<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>ğŸƒ ìœ ë ¹ í”¼í•˜ê¸° - Halloween Mini Game</title>
    <style>
        :root{ --bg:#0b0b14; --fg:#f7f2ff; --acc:#ff7a00; --vio:#7a3cff; --red:#ff3b3b; --green:#31d27c; }
        *{box-sizing:border-box}
        html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:radial-gradient(1200px 800px at 70% -10%, #1b1440 0%, rgba(27,20,64,0) 60%) , var(--bg);color:var(--fg)}
        .wrap{display:flex;min-height:100%;}
        canvas{display:block; width:100%; height:100vh; outline:none}

        /* UI Overlay */
        .hud{position:fixed;inset:0;pointer-events:none}
        .hud-inner{position:absolute;left:0;right:0;top:0;display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px}
        .pill{backdrop-filter: blur(8px); background:rgba(10,10,20,.35); border:1px solid rgba(255,255,255,.08); color:var(--fg); padding:8px 12px; border-radius:999px; font-weight:700; letter-spacing:.2px; box-shadow:0 8px 24px rgba(0,0,0,.3)}
        .score{font-variant-numeric:tabular-nums}
        .btns{display:flex; gap:8px; pointer-events:auto}
        .btn{cursor:pointer; user-select:none}
        .btn:active{transform:translateY(1px)}

        /* Centered modal */
        .modal{position:fixed; inset:0; display:grid; place-items:center; background:linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,.4));}
        .card{width:min(820px,92vw); border-radius:24px; padding:24px; border:1px solid rgba(255,255,255,.12); background:linear-gradient(180deg, rgba(16,16,28,.9), rgba(16,16,28,.7)); box-shadow:0 30px 80px rgba(0,0,0,.45)}
        h1{margin:0 0 8px; font-size:clamp(28px, 4vw, 40px)}
        .sub{opacity:.85; margin:0 0 16px; line-height:1.5}
        .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
        .primary{pointer-events:auto; cursor:pointer; padding:14px 18px; border-radius:14px; background:linear-gradient(180deg, var(--acc), #ff5e00); color:#190b00; font-weight:900; border:none; box-shadow:0 12px 24px rgba(255,122,0,.26)}
        .ghost{color:#fff; opacity:.9}
        .kbd{padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06)}

        /* Rules & how section */
        .rules{margin:0 0 16px 16px; line-height:1.7}
        #how{display:none; margin-top:12px; opacity:.9}
        .howline{margin:0 0 6px}

        /* ì‹­ìí˜• D-Pad (ëª¨ë°”ì¼ ì „ìš©) */
        .pad{
            position:fixed;
            bottom:16px;
            right:16px;
            width:160px;
            height:160px;
            pointer-events:auto;
        }
        .pad-btn{
            position:absolute;
            width:56px; height:56px;
            border-radius:14px;
            border:1px solid rgba(255,255,255,.12);
            background:rgba(255,255,255,.05);
            color:var(--fg); font-weight:700;
            touch-action:none;
        }
        .pad-up{    left:52px; top:0;     }
        .pad-down{  left:52px; bottom:0;  }
        .pad-left{  left:0;    top:52px;  }
        .pad-right{ right:0;   top:52px;  }
        .pad-center{
            position:absolute;
            left:52px; top:52px;
            width:56px; height:56px;
            border-radius:14px;
            border:1px solid rgba(255,255,255,.08);
            background:rgba(255,255,255,.03);
            pointer-events:none;
        }
        @media (min-width: 900px){ .pad{display:none} }

        /* Leaderboard list rows */
        .lb-row{display:flex; gap:8px; align-items:center; padding:6px 8px; border-bottom:1px solid rgba(255,255,255,.06);}
        .lb-rank{width:28px; text-align:right; opacity:.8;}
        .lb-name{flex:1; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
        .lb-score{width:80px; text-align:right;}
    </style>

    <!-- (ì„ íƒ) reCAPTCHA v3 â€” ì‚¬ìš© ì‹œ Site Key ë„£ê¸° -->
    <!-- <script src="https://www.google.com/recaptcha/api.js?render=YOUR_SITE_KEY"></script> -->
</head>
<body>
<div class="wrap">
    <canvas id="game" tabindex="0" aria-label="ìœ ë ¹ í”¼í•˜ê¸° ê²Œì„ ìº”ë²„ìŠ¤"></canvas>
</div>

<!-- HUD -->
<div class="hud" aria-hidden="true">
    <div class="hud-inner">
        <div class="pill score" id="score">ì ìˆ˜ 000</div>
        <div class="pill" id="status">â¤ï¸ Ã— <span id="lives">3</span> &nbsp; â³ <span id="time">60</span>s</div>
        <div class="btns">
            <button class="pill btn" id="pauseBtn" title="ì¼ì‹œì •ì§€(P)">â¸ï¸ Pause</button>
            <button class="pill btn" id="restartBtn" title="ë‹¤ì‹œ ì‹œì‘(R)">ğŸ” Restart</button>
        </div>
    </div>
</div>

<!-- Start / GameOver Modal -->
<div class="modal" id="modal">
    <div class="card">
        <h1>ğŸ‘» ìœ ë ¹ í”¼í•˜ê¸°</h1>
        <p class="sub">ë°©í–¥í‚¤(ë˜ëŠ” <span class="kbd">W</span><span class="kbd">A</span><span class="kbd">S</span><span class="kbd">D</span>)ë¡œ ì›€ì§ì—¬ <b>ìœ ë ¹(ğŸ‘»)ì„ í”¼í•˜ê³ </b> <b>í˜¸ë°•(ğŸƒ)</b>ì„ ëª¨ì•„ ì ìˆ˜ë¥¼ ì˜¬ë¦¬ì„¸ìš”! ì œí•œ ì‹œê°„ <b>60ì´ˆ</b> ë™ì•ˆ ìƒì¡´í•˜ì„¸ìš”.</p>
        <ul class="rules">
            <li>í˜¸ë°•(ğŸƒ) +10ì , ì—°ì† ìˆ˜ì§‘ ì‹œ ì½¤ë³´ ë³´ë„ˆìŠ¤</li>
            <li>ìœ ë ¹ê³¼ ì¶©ëŒ ì‹œ â¤ï¸ -1 (ë¬´ì ì‹œê°„ 1ì´ˆ)</li>
            <li>ë‚œì´ë„ëŠ” ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ì ì  ì¦ê°€í•©ë‹ˆë‹¤</li>
            <li>10ì´ˆë§ˆë‹¤ <b>ì‚¬íƒ•(ğŸ¬)</b> ë“±ì¥ â€” íšë“ ì‹œ <b>4ì´ˆê°„ ì´ë™ì†ë„ 2ë°°</b></li>
            <li>í˜¸ë°•(ğŸƒ) <b>5ê°œ</b> ìˆ˜ì§‘í•  ë•Œë§ˆë‹¤ â± 1ì´ˆ ì¦ê°€</li>
        </ul>
        <div class="row">
            <button class="primary" id="startBtn">ê²Œì„ ì‹œì‘</button>
            <button class="pill btn" id="howBtn">ì¡°ì‘ ì•ˆë‚´</button>
        </div>

        <!-- [NEW] ì ìˆ˜ ì œì¶œ & ë¦¬ë”ë³´ë“œ -->
        <div id="submitWrap" style="display:none; margin-top:12px;">
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                <input id="playerName" type="text" maxlength="16"
                       placeholder="ë‹‰ë„¤ì„(ìµœëŒ€ 16ì)"
                       style="flex:1; min-width:180px; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); color:var(--fg);" />
                <button class="primary" id="submitBtn">ì ìˆ˜ ì œì¶œ</button>
            </div>
            <p class="sub" id="submitMsg" style="margin:8px 0 0 0; display:none;"></p>
        </div>

        <div id="lbWrap" style="display:none; margin-top:16px;">
            <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                <strong>ğŸ† ë¦¬ë”ë³´ë“œ (ë¡œë”©ì§€ì¡´í•µëŠë¦¬ë‹ˆê¹Œ ì œì¶œí•˜ê³  ìª½ê¸ˆë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)</strong>
                <!--<select id="lbPeriod" class="pill" style="pointer-events:auto; padding:6px 10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);">
                    <option value="all">ì „ì²´</option>
                    <option value="week">ì£¼ê°„</option>
                    <option value="day">ì¼ê°„</option>
                </select>-->
            </div>
            <div id="lbList" style="max-height:260px; overflow:auto; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:8px; background:rgba(255,255,255,.04);"></div>
        </div>

        <div id="how" style="display:none;">
            <p class="howline">ğŸ”¹ <b>í‚¤ë³´ë“œ</b>: ë°©í–¥í‚¤, <b>P</b> ì¼ì‹œì •ì§€, <b>R</b> ì¬ì‹œì‘</p>
            <p class="howline">ğŸ”¹ <b>ëª¨ë°”ì¼</b>: ì•„ë˜ í„°ì¹˜ íŒ¨ë“œë¡œ ì´ë™</p>
        </div>
    </div>
</div>

<!-- Mobile D-Pad -->
<div class="pad" id="pad" aria-hidden="true">
    <button class="pad-btn pad-up"    data-dir="up"    aria-label="ìœ„ë¡œ">â¬†ï¸</button>
    <button class="pad-btn pad-left"  data-dir="left"  aria-label="ì™¼ìª½">â¬…ï¸</button>
    <button class="pad-btn pad-right" data-dir="right" aria-label="ì˜¤ë¥¸ìª½">â¡ï¸</button>
    <button class="pad-btn pad-down"  data-dir="down"  aria-label="ì•„ë˜ë¡œ">â¬‡ï¸</button>
    <div class="pad-center" aria-hidden="true"></div>
</div>

<div class="cta"><a class="link" id="ctaLink" href="#" rel="noopener">íŒŒí‹° ì°¸ê°€ ì‹ ì²­ âœ¨</a></div>

<script>
    (function(){
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        let W=window.innerWidth, H=window.innerHeight;
        function resize(){ W=window.innerWidth; H=window.innerHeight; canvas.width=W*dpr; canvas.height=H*dpr; canvas.style.width=W+'px'; canvas.style.height=H+'px'; ctx.setTransform(dpr,0,0,dpr,0,0); }
        window.addEventListener('resize', resize, {passive:true}); resize();

        /* === [NEW] ë¦¬ë”ë³´ë“œ ì—°ë™ ìƒìˆ˜ === */
        const API_URL = 'https://curly-haze-9d14.940raphael.workers.dev';
        const RECAPTCHA_SITE_KEY = ''; // ì‚¬ìš© ì‹œ ì‚¬ì´íŠ¸ í‚¤, ë¯¸ì‚¬ìš© ì‹œ ë¹ˆ ë¬¸ìì—´

        /* === [NEW] UUID & playerId === */
        function getOrCreatePlayerId(){
            const key = 'playerId';
            let id = localStorage.getItem(key);
            if(!id){
                id = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
                );
                localStorage.setItem(key, id);
            }
            return id;
        }

        /* === [NEW] ì ìˆ˜ ì œì¶œ === */
        async function submitScore({ name, score, durationMs }){
            const playerId = getOrCreatePlayerId();
            let recaptchaToken = '';
            if (RECAPTCHA_SITE_KEY && typeof grecaptcha !== 'undefined') {
                try { recaptchaToken = await grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'submit' }); } catch(_) {}
            }
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ playerId, name, score, durationMs, recaptchaToken })
            });
            return res.json();
        }

        /* === [NEW] ë¦¬ë”ë³´ë“œ ì¡°íšŒ === */
        async function getTop({ limit = 50, period = 'all' } = {}){
            const url = `${API_URL}?action=top&limit=${limit}&period=${period}`;
            const res = await fetch(url);
            return res.json();
        }

        /* === [NEW] ë¦¬ë”ë³´ë“œ ë Œë”ë§ === */
        function renderLeaderboard(list){
            const el = document.getElementById('lbList');
            if (!el) return;
            if (!list || !list.length) {
                el.innerHTML = '<div class="ghost">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            el.innerHTML = list.map(item => {
                const safeName = (item.name || 'Anonymous').replace(/[<>&]/g, s => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]));
                return `<div class="lb-row"><div class="lb-rank">${item.rank}</div><div class="lb-name">${safeName}</div><div class="lb-score">${item.score}</div></div>`;
            }).join('');
        }

        // --- Game State ---
        const state = {
            running:false,
            paused:false,
            timeLimit:60,
            timeLeft:60,
            score:0,
            combo:0,
            lives:3,
            invuln:0,
            ghosts:[],
            candies:[],
            powerups:[],
            particles:[],
            last:0,
            speedBoost:0,
            powerupTimer:0,
            pumpkinsCollected:0,
            startedAt:0, // [NEW] ì‹œì‘ ì‹œê°(ms)
        };

        const player = { x:W*0.5, y:H*0.6, r:18, speed:260, vx:0, vy:0 };

        function rand(min,max){ return Math.random()*(max-min)+min; }
        function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

        // Keyboard & Touch
        const keys = new Set();
        function isTypingTarget(el){
            if(!el) return false;
            const tag = el.tagName?.toLowerCase();
            return tag === 'input' || tag === 'textarea' || el.isContentEditable;
        }

        window.addEventListener('keydown', (e)=>{
            // âœ… ì¸í’‹/í…ìŠ¤íŠ¸ ì˜ì—­ì—ì„œëŠ” ê²Œì„ í‚¤ ì²˜ë¦¬ ì¤‘ë‹¨
            if (isTypingTarget(e.target)) return;

            if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','w','a','s','d','W','A','S','D','p','P','r','R'].includes(e.key)) {
                e.preventDefault();
            }
            if (e.key==='p' || e.key==='P'){ togglePause(); return; }
            if (e.key==='r' || e.key==='R'){ restart(); return; }
            keys.add(e.key.toLowerCase());
        });

        window.addEventListener('keyup', (e)=>{
            if (isTypingTarget(e.target)) return;
            keys.delete(e.key.toLowerCase());
        });


        // Mobile D-Pad
        const pad = document.getElementById('pad');
        const touchDir = { up:false, down:false, left:false, right:false };
        function setDir(dir, isDown){ touchDir[dir] = isDown; }
        function bindPadButton(btn){
            const dir = btn.dataset.dir;
            btn.addEventListener('touchstart', (e)=>{ e.preventDefault(); setDir(dir, true); }, {passive:false});
            btn.addEventListener('touchend',   (e)=>{ e.preventDefault(); setDir(dir, false); }, {passive:false});
            btn.addEventListener('touchcancel',(e)=>{ e.preventDefault(); setDir(dir, false); }, {passive:false});
            btn.addEventListener('mousedown',  (e)=>{ e.preventDefault(); setDir(dir, true); });
            ['mouseup','mouseleave','mouseout'].forEach(ev=> btn.addEventListener(ev, (e)=>{ e.preventDefault(); setDir(dir, false); }));
        }
        pad.querySelectorAll('.pad-btn').forEach(bindPadButton);

        // UI Elements
        const scoreEl   = document.getElementById('score');
        const livesEl   = document.getElementById('lives');
        const timeEl    = document.getElementById('time');
        const pauseBtn  = document.getElementById('pauseBtn');
        const restartBtn= document.getElementById('restartBtn');
        const modal     = document.getElementById('modal');
        const startBtn  = document.getElementById('startBtn');
        const howBtn    = document.getElementById('howBtn');
        const how       = document.getElementById('how');
        const ctaLink   = document.getElementById('ctaLink');

        // [NEW] ì œì¶œ/ë¦¬ë”ë³´ë“œ UI
        const submitWrap = document.getElementById('submitWrap');
        const submitBtn  = document.getElementById('submitBtn');
        const submitMsg  = document.getElementById('submitMsg');
        const playerNameInput = document.getElementById('playerName');
        const lbWrap   = document.getElementById('lbWrap');
        const lbList   = document.getElementById('lbList');
        //const lbPeriod = document.getElementById('lbPeriod');

        howBtn.addEventListener('click', ()=> how.style.display = (how.style.display==='none')?'block':'none');
        startBtn.addEventListener('click', start);
        pauseBtn.addEventListener('click', togglePause);
        restartBtn.addEventListener('click', restart);
        ctaLink.addEventListener('click', (e)=>{ if(!ctaLink.dataset.href){ e.preventDefault(); alert('ê´€ë¦¬ì: ìš°ì¸¡ í•˜ë‹¨ ë²„íŠ¼ ë§í¬ë¥¼ data-hrefì— ì„¤ì •í•˜ì„¸ìš”.'); } });

        // ë¦¬ë”ë³´ë“œ ê¸°ê°„ ë³€ê²½
        //if (lbPeriod) {
        //    lbPeriod.addEventListener('change', async () => {
        //        try {
        //            const { items } = await getTop({ limit: 50, period: lbPeriod.value });
        //            renderLeaderboard(items);
        //        } catch (e) {
        //            if (lbList) lbList.innerHTML = '<div class="ghost">ë¦¬ë”ë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        //       }
        //   });
        //}

        // ì ìˆ˜ ì œì¶œ
        if (submitBtn) {
            submitBtn.addEventListener('click', async () => {
                submitBtn.disabled = true;
                submitMsg.style.display = 'block';
                submitMsg.textContent = 'ì œì¶œ ì¤‘...';

                const name = (playerNameInput.value || '').trim() || 'Anonymous';
                localStorage.setItem('playerName', name);
                const score = state.score;
                const durationMs = Math.max(0, Date.now() - (state.startedAt || Date.now()));

                try {
                    const res = await submitScore({ name, score, durationMs });
                    if (res && res.ok) {
                        submitMsg.textContent = 'ê¸°ë¡ ì €ì¥ ì™„ë£Œ!';
                        const { items } = await getTop({ limit: 50, period: 'all' });
                        renderLeaderboard(items);
                    } else {
                        submitMsg.textContent = `ì €ì¥ ì‹¤íŒ¨: ${res && res.error ? res.error : 'unknown'}`;
                    }
                } catch (err) {
                    submitMsg.textContent = 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                } finally {
                    submitBtn.disabled = false;
                }
            });
        }

        // Helper to let host easily set CTA link via URL query
        (function initLink(){
            try{
                const url = new URL(location.href);
                const link = url.searchParams.get('link');
                if(link){ ctaLink.href = link; ctaLink.dataset.href = '1'; }
            }catch(err){}
        })();

        // Ghost & Candy spawners
        function spawnGhost(){
            const speed = rand(60, 130) + (60 - state.timeLeft) * 1.5;

            // ì ìˆ˜ ê¸°ë°˜ ìœ ë ¹ í¬ê¸°
            const baseSize = rand(16, 26);
            let growth = 1;
            if (state.score >= 1500) {
                growth = 1 + Math.min(1.5, (state.score - 1500) / 1500 * 1.5); // ìµœëŒ€ 2.5ë°°
            } else {
                growth = Math.max(0.7, state.score / 1500); // ì €ì ì¼ìˆ˜ë¡ ì‘ê²Œ(ìµœì†Œ 0.7ë°°)
            }
            const size = baseSize * growth;

            const edge = Math.floor(rand(0,4));
            let x,y,vx,vy;
            if(edge===0){ x=rand(0,W); y=-40; vx=rand(-1,1); vy=1; }
            else if(edge===1){ x=W+40; y=rand(0,H); vx=-1; vy=rand(-.5,.5); }
            else if(edge===2){ x=rand(0,W); y=H+40; vx=rand(-1,1); vy=-1; }
            else { x=-40; y=rand(0,H); vx=1; vy=rand(-.5,.5); }
            const len = Math.hypot(vx,vy)||1; vx*=speed/len; vy*=speed/len;
            state.ghosts.push({x,y,vx,vy,r:size});
        }

        function spawnCandy(){
            const x = rand(40, W-40), y = rand(40, H-40);
            state.candies.push({x,y,r:14, life:10}); // 10s lifetime
        }

        function spawnPowerup(){
            const x = rand(40, W-40), y = rand(40, H-40);
            state.powerups.push({x, y, r:14, life:5}); // 5s lifetime
        }

        // Particles
        function burst(x,y,emoji='âœ¨'){
            for(let i=0;i<12;i++){
                const a = Math.random()*Math.PI*2, s = rand(40,140);
                state.particles.push({x,y,vx:Math.cos(a)*s, vy:Math.sin(a)*s, life:0.6, emoji, size:16});
            }
        }

        // Audio (Web Audio API)
        const AudioCtx = window.AudioContext || window.webkitAudioContext; let actx;
        function beep(type='square', f=660, t=0.07, v=0.05){
            if(!actx) actx = new AudioCtx();
            const o = actx.createOscillator(); const g = actx.createGain();
            o.type=type; o.frequency.value=f; g.gain.value=v; o.connect(g); g.connect(actx.destination); o.start(); o.stop(actx.currentTime+t);
        }

        function update(dt){
            if(!state.running || state.paused) return;

            state.last += dt;
            state.invuln = Math.max(0, state.invuln - dt);

            if(state.speedBoost > 0){
                state.speedBoost = Math.max(0, state.speedBoost - dt);
            }

            // Timer
            state.timeLeft = Math.max(0, state.timeLeft - dt);
            if(state.timeLeft<=0){ gameOver(true); }

            // Spawn rates
            if(state.last> (0.6 - Math.min(0.45, (60 - state.timeLeft)*0.004))){ spawnGhost(); state.last=0; }
            if(Math.random()<0.02){ spawnCandy(); }

            // 10ì´ˆë§ˆë‹¤ ìŠ¤í”¼ë“œ ì‚¬íƒ• ìŠ¤í°
            state.powerupTimer += dt;
            if(state.powerupTimer >= 10){
                state.powerupTimer = 0;
                spawnPowerup();
            }

            // Player movement
            let ax=0, ay=0;
            if(keys.has('arrowup')||keys.has('w')||touchDir.up) ay -= 1;
            if(keys.has('arrowdown')||keys.has('s')||touchDir.down) ay += 1;
            if(keys.has('arrowleft')||keys.has('a')||touchDir.left) ax -= 1;
            if(keys.has('arrowright')||keys.has('d')||touchDir.right) ax += 1;
            const len = Math.hypot(ax,ay)||1;

            const curSpeed = player.speed * (state.speedBoost > 0 ? 2 : 1);
            player.vx = (ax/len) * curSpeed;
            player.vy = (ay/len) * curSpeed;
            player.x = clamp(player.x + player.vx*dt, player.r, W-player.r);
            player.y = clamp(player.y + player.vy*dt, player.r, H-player.r);

            // Ghosts
            for(const g of state.ghosts){
                g.x += g.vx*dt; g.y += g.vy*dt;
                if(g.x<-60||g.x>W+60||g.y<-60||g.y>H+60) g.dead=true;
                const dx = player.x - g.x, dy = player.y - g.y; const d = Math.hypot(dx,dy)||1;
                const steer = 20 * dt; g.vx += (dx/d)*steer; g.vy += (dy/d)*steer;
            }
            state.ghosts = state.ghosts.filter(g=>!g.dead);

            // Candies / Powerups lifetime
            for(const c of state.candies){ c.life -= dt; if(c.life<=0) c.dead=true; }
            for(const p of state.powerups){ p.life -= dt; if(p.life<=0) p.dead=true; }

            // Collisions
            for(const g of state.ghosts){
                const d = Math.hypot(player.x-g.x, player.y-g.y);
                if(d < player.r + g.r){
                    if(state.invuln<=0){
                        state.lives--; state.invuln=1.0; flash(); beep('sawtooth', 200, .09, .07); burst(player.x, player.y, 'ğŸ’¥');
                        if(state.lives<=0){ gameOver(false); }
                    }
                }
            }

            // ğŸƒ pick
            for (const c of state.candies) {
                const d = Math.hypot(player.x - c.x, player.y - c.y);
                if (d < player.r + c.r) {
                    c.dead = true;
                    const bonus = 10 + Math.min(50, state.combo * 2);
                    state.score += bonus;
                    state.combo++;

                    // 5ê°œë§ˆë‹¤ 1ì´ˆ ì¶”ê°€
                    state.pumpkinsCollected++;
                    if (state.pumpkinsCollected % 5 === 0) {
                        state.timeLeft += 1;
                        popScore(player.x, player.y - 28, 'â± +1s');
                        beep('square', 960, .12, .06);
                        burst(player.x, player.y, 'â±');
                    }

                    popScore(c.x, c.y, `+${bonus}`);
                    beep('triangle', 880, .07, .05);
                    burst(c.x, c.y, 'ğŸ†');
                }
            }
            state.candies = state.candies.filter(c=>!c.dead);

            // ğŸ¬ pick
            for(const p of state.powerups){
                const d = Math.hypot(player.x-p.x, player.y-p.y);
                if(d < player.r + p.r){
                    p.dead = true;
                    state.speedBoost = 4.0; // 4ì´ˆê°„ 2ë°° ì†ë„
                    popScore(p.x, p.y, 'âš¡ SPEED x2');
                    beep('sine', 1120, .09, .06);
                    burst(p.x, p.y, 'âš¡');
                }
            }
            state.powerups = state.powerups.filter(p=>!p.dead);

            // Particles
            for(const p of state.particles){ p.life -= dt; p.x += p.vx*dt; p.y += p.vy*dt; }
            state.particles = state.particles.filter(p=>p.life>0);

            // UI
            scoreEl.textContent = `ì ìˆ˜ ${String(state.score).padStart(3,'0')}`;
            livesEl.textContent = state.lives;
            timeEl.textContent = Math.ceil(state.timeLeft);
        }

        // Visuals
        function draw(){
            ctx.clearRect(0,0,W,H);
            const grd = ctx.createRadialGradient(player.x, player.y, 20, player.x, player.y, Math.max(W,H));
            grd.addColorStop(0,'rgba(255,170,60,0.12)');
            grd.addColorStop(1,'rgba(0,0,0,0)');
            ctx.fillStyle=grd; ctx.fillRect(0,0,W,H);

            // stars / fog
            ctx.globalAlpha = 0.09; ctx.fillStyle = '#fff';
            for(let i=0;i<60;i++){ ctx.fillRect(((i*73)%W), ((i*131)%H), 2, 2); }
            ctx.globalAlpha = 1;

            // ğŸƒ
            for (const c of state.candies) {
                const alpha = blinkAlpha(c.life, 1.5, 7);
                if (alpha === 0) continue;
                ctx.globalAlpha = alpha;
                drawEmoji('ğŸƒ', c.x, c.y, 24);
                ctx.globalAlpha = 1;
            }

            // ğŸ¬
            for (const p of state.powerups) {
                const alpha = blinkAlpha(p.life, 1.5, 7);
                if (alpha === 0) continue;
                ctx.globalAlpha = alpha;
                drawEmoji('ğŸ¬', p.x, p.y, 24);
                ctx.globalAlpha = 1;
            }

            // ğŸ‘»
            for(const g of state.ghosts){ drawEmoji('ğŸ‘»', g.x, g.y, g.r*2); }

            // player
            const flick = state.invuln>0 ? (Math.sin(performance.now()/60)>0?0:1) : 1;
            if(flick){
                ctx.beginPath(); ctx.arc(player.x, player.y, player.r, 0, Math.PI*2);
                const grd2 = ctx.createLinearGradient(player.x, player.y-player.r, player.x, player.y+player.r);
                grd2.addColorStop(0, '#2b2b44'); grd2.addColorStop(1, '#6a5acd');
                ctx.fillStyle = grd2; ctx.fill();

                if(state.speedBoost > 0){
                    ctx.lineWidth = 3;
                    ctx.strokeStyle = 'rgba(255, 200, 80, 0.6)';
                    ctx.beginPath();
                    ctx.arc(player.x, player.y, player.r + 6, 0, Math.PI*2);
                    ctx.stroke();
                }
                drawEmoji('ğŸ§™â€â™€ï¸', player.x, player.y-12, 26);
            }

            // particles
            for(const p of state.particles){ ctx.globalAlpha = Math.max(0,p.life*1.4); drawEmoji(p.emoji, p.x, p.y, p.size); ctx.globalAlpha = 1; }

            // edge glow
            ctx.strokeStyle = 'rgba(255,255,255,.06)'; ctx.strokeRect(1,1,W-2,H-2);
        }

        function drawEmoji(emoji, x, y, size){ ctx.font = `bold ${size}px Apple Color Emoji, "Segoe UI Emoji", Noto Color Emoji, sans-serif`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(emoji, x, y); }

        // ê¹œë¹¡ì„ ì•ŒíŒŒ
        function blinkAlpha(remain, threshold = 1.5, hz = 7){
            if (remain >= threshold) return 1;
            const t = performance.now() / 1000;
            return Math.sin(t * hz * 2 * Math.PI) > 0 ? 1 : 0;
        }

        // UI feedbacks
        let flashes=0; function flash(){ flashes=6; }
        function renderFlash(){ if(flashes>0){ flashes--; ctx.fillStyle='rgba(255,60,60,.12)'; ctx.fillRect(0,0,W,H); } }

        // Floating score pop
        const pops=[]; function popScore(x,y,text){ pops.push({x,y,vy:-40,life:1,text}); }
        function drawPops(dt){ for(const p of pops){ p.life -= dt; p.y += p.vy*dt; ctx.globalAlpha = Math.max(0,p.life); ctx.fillStyle = '#ffdca8'; ctx.font = '700 22px ui-sans-serif, system-ui'; ctx.textAlign='center'; ctx.fillText(p.text, p.x, p.y); ctx.globalAlpha=1; } for(let i=pops.length-1;i>=0;i--){ if(pops[i].life<=0) pops.splice(i,1); } }

        // Game Flow
        let rafId; let lastTs=0;
        function loop(ts){
            rafId = requestAnimationFrame(loop);
            const dt = Math.min(0.033, (ts - (lastTs||ts)) / 1000); lastTs=ts;
            update(dt); draw(); drawPops(dt); renderFlash();
        }

        function start(){
            reset();
            state.startedAt = Date.now(); // [NEW]
            modal.style.display='none'; canvas.focus();
            state.running=true; state.paused=false; lastTs=0;
            cancelAnimationFrame(rafId); rafId = requestAnimationFrame(loop);
            beep('square', 520, .08, .05);
        }
        function reset(){
            state.timeLeft = state.timeLimit; state.score=0; state.combo=0; state.lives=3; state.invuln=0;
            state.ghosts.length=0; state.candies.length=0; state.particles.length=0;
            state.powerups.length = 0; state.powerupTimer = 0; state.speedBoost = 0; state.pumpkinsCollected = 0;
            player.x=W*0.5; player.y=H*0.6;

            // ëª¨ë‹¬ ë‚´ UI ì´ˆê¸°í™”
            if (submitWrap) submitWrap.style.display = 'none';
            if (lbWrap) lbWrap.style.display = 'none';
            if (submitMsg) { submitMsg.style.display = 'none'; submitMsg.textContent = ''; }
        }
        function togglePause(){ if(!state.running) return; state.paused=!state.paused; pauseBtn.textContent = state.paused? 'â–¶ï¸ Resume':'â¸ï¸ Pause'; if(!state.paused){ lastTs=0; } beep('sine', state.paused?260:420, .05, .04); }
        function restart(){
            reset();
            state.startedAt = Date.now(); // [NEW]
            state.paused=false; pauseBtn.textContent='â¸ï¸ Pause';
            modal.style.display='none'; canvas.focus();
            beep('triangle', 640, .06, .05);
        }
        function gameOver(win){
            state.running=false; cancelAnimationFrame(rafId);
            const title = win? 'ğŸ‰ ìƒì¡´ ì„±ê³µ!':'ğŸ’€ ìœ ë ¹ì—ê²Œ ì¡í˜”ì–´ìš”!';
            const msg = `ìµœì¢… ì ìˆ˜: ${state.score}`;
            showModal(title, msg);
            beep('sawtooth', win? 880:160, .15, .06);
        }

        function showModal(title, msg){
            modal.style.display='grid';
            const h1 = modal.querySelector('h1');
            const sub = modal.querySelector('.sub');
            h1.innerText = title;
            sub.innerText = msg + '  â€”  R í‚¤ë¡œ ë‹¤ì‹œ ì‹œì‘í•˜ê±°ë‚˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¬ì‹œì‘í•˜ì„¸ìš”.';

            // ê²Œì„ì˜¤ë²„ ì‹œ ì œì¶œ UI & ë¦¬ë”ë³´ë“œ í‘œì‹œ
            if (title.includes('ìƒì¡´') || title.includes('ì¡í˜”ì–´ìš”') || title.includes('ìµœì¢…')) {
                if (submitWrap) submitWrap.style.display = 'block';
                if (lbWrap) lbWrap.style.display = 'block';
                if (submitMsg) { submitMsg.style.display = 'none'; submitMsg.textContent = ''; }

                // ì´ë¦„ ìë™ ë³µì›
                if (playerNameInput) {
                    const prev = localStorage.getItem('playerName') || '';
                    if (prev) playerNameInput.value = prev;
                    playerNameInput.focus();
                    playerNameInput.addEventListener('change', () => {
                        localStorage.setItem('playerName', playerNameInput.value || '');
                    }, { once:false });
                }

                // ë¦¬ë”ë³´ë“œ ë¡œë”©
                (async () => {
                    try {
                        const { items } = await getTop({ limit: 50, period: 'all' });
                        renderLeaderboard(items);
                    } catch (e) {
                        if (lbList) lbList.innerHTML = '<div class="ghost">ë¦¬ë”ë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                    }
                })();
            } else {
                if (submitWrap) submitWrap.style.display = 'none';
                if (lbWrap) lbWrap.style.display = 'none';
            }
            modal.style.display='grid';
            // âœ… ë‹‰ë„¤ì„ ì¸í’‹ì— í¬ì»¤ìŠ¤ ì£¼ê¸° (ì•½ê°„ì˜ ì§€ì—°ì´ ì•ˆì •ì )
            const ip = document.getElementById('playerName');
            if (ip) setTimeout(()=> ip.focus(), 60);
        }

        // Focus for keyboard
        canvas.addEventListener('click', ()=> canvas.focus());

        // Kick off idle loop
        cancelAnimationFrame(rafId); rafId=requestAnimationFrame(loop);
    })();
</script>
</body>
</html>
